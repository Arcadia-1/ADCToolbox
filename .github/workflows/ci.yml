name: CI - Code Quality

on:
  pull_request:
    branches: [ main ]
  push:
    branches: [ main ]

jobs:
  matlab-syntax-check:
    name: MATLAB Syntax Check
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up MATLAB
        uses: matlab-actions/setup-matlab@v2
        with:
          release: R2024b

      - name: Check MATLAB syntax
        uses: matlab-actions/run-command@v2
        with:
          command: |
            fprintf('=== MATLAB Syntax Check ===\n');
            srcFiles = dir(fullfile('matlab', 'src', '*.m'));
            fprintf('Found %d files in matlab/src/\n', length(srcFiles));
            hasErrors = false;
            for i = 1:length(srcFiles)
              filePath = fullfile(srcFiles(i).folder, srcFiles(i).name);
              try
                info = checkcode(filePath);
                if isempty(info)
                  fprintf('✓ %s\n', srcFiles(i).name);
                else
                  fprintf('⚠ %s has %d warnings\n', srcFiles(i).name, length(info));
                end
              catch ME
                fprintf('✗ %s: %s\n', srcFiles(i).name, ME.message);
                hasErrors = true;
              end
            end
            if hasErrors
              error('Syntax errors found');
            end
            fprintf('\n✓ All MATLAB files are syntactically valid\n');

  python-syntax-check:
    name: Python Syntax Check
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Check Python syntax
        run: |
          echo "=== Python Syntax Check ==="
          find python/adctoolbox -name "*.py" -type f | while read file; do
            python -m py_compile "$file" && echo "✓ $file" || { echo "✗ $file"; exit 1; }
          done
          echo ""
          echo "✓ All Python files are syntactically valid"
